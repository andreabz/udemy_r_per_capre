---
title: "R per capre - dal foglio di calcolo al report automatico"
subtitle: "Materiale di supporto per gli episodi 18 e 19 - la fabbrica di report"
lang: it
format:
  pdf:
    documentclass: article
    papersize: a4
    margin-left: 2.5cm
    margin-right: 2.5cm
    margin-top: 3cm
    margin-bottom: 3cm
    fontsize: 11pt
    mainfont: Inter
    monofont: JetBrains Mono
    linkcolor: teal
    urlcolor: teal
    toc: false
---

::: {.small}
Repository del corso: <https://github.com/andreabz/udemy_r_per_capre>
:::

## Obiettivo degli episodi

Generare report **parametrici e automatici**.

Utilizzeremo:

- **Parametri**: valori che cambiano da report a report senza modificare il codice interno  
- **Ciclo `for` + `quarto_render()`**: metodo per creare **più report in serie**


## Parametri in Quarto

Nei report Quarto possiamo definire parametri nel YAML:


```yaml
---
title: "Numero di campioni e tempi di analisi"
format: html
params: 
  method: "CHEM0543d" 
  year: 2024
  target: 6
---
```

All'interno del report possiamo usarli così:

```{r}
#| eval: false

misure[id_metodo == params$method,
              .(
                campioni = uniqueN(id_campione),
                analisi_mediana = median(tempo_analisi |> as.numeric()),
                analisi_veloce = quantile(tempo_analisi, 0.10),
                analisi_lenta = quantile(tempo_analisi, 0.90)
                ),
              by = .(mese_inizio_analisi)]
```

per accedere ai soli dati del metodo specificato con `params$method`.

- Cambiando `params$method` o `params$target`, il report si aggiorna senza modificare il codice R.
- Utile per avere una fabbrica di report per diversi metodi e target.

## Ciclo `for` e `quarto_render()`

Per generare report per più metodi e target:

```{r}
#| eval: false

# Ricorda di scrivere install.packages("quarto")
# Carico la libreria
library(quarto)

# elenco i metodi per cui voglio ottenere un report
metodi <- c(
  "CHEM5421c",
  "CHEM0543d",
  "CHEM0214i"
)
# elenco dei tempi target
obiettivi <- c(15, 6, 3)

# combinazioni
combinazioni <- data.frame(metodi = metodi, obiettivi = obiettivi)

# ciclo di rendering
for (riga in 1:nrow(combinazioni)) {
  metodo <- combinazioni$metodi[riga]
  target <- combinazioni$obiettivi[riga]

  # Nome finale dell'HTML (solo il nome)
  output_file <- paste0("report_", tolower(metodo), "_2024.html")

  # Render
  quarto_render(
    input = "report.qmd",
    execute_params = list(method = metodo, target = target),
    output_file = output_file
  )
}
```

- `combinazioni` contiene i metodi e i target
- `output_file` è il nome del report generato
- `quarto_render()` esegue il report con i parametri specificati
- il ciclo `for` ripete l'operazione per tutte le combinazioni

## Vantaggi

- Zero copia/incolla: niente Excel/Word manuali
- Scalabilità: basta aggiungere nuovi metodi o dataset
- Riproducibilità: report coerenti e automatici
- Aggiornamento semplice: cambiando dati o parametri, si rigenerano i report

## Controlli

- I nomi dei parametri nel YAML devono coincidere con quelli passati in `execute_params`
- Evitare spazi o caratteri speciali nei nomi dei report
- Mantenere lo stesso formato dei dataset per tutti i report

## Punto chiave

Combinando un report parametrizzato e un ciclo,
è possibile creare una fabbrica di report che condividono la stessa struttura ma utilizzano dati diversi.

## In sintesi

- Parametri = valori dinamici che cambiano il report senza toccare il codice
- `quarto_render()` + `for` = fabbrica di report automatica

Con questo approccio:

- Basta copia-incolla da Excel a Word
- I report sono sempre aggiornati, coerenti e riproducibili
